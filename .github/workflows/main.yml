name: Flutter APK Build
on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      # 1Ô∏è‚É£ ANDROID YOKSA OLU≈ûTUR
      - name: Create Android if missing
        run: |
          if [ ! -d "android" ]; then
            flutter create . --platforms=android
          fi

      # 2Ô∏è‚É£ pubspec.yaml'ƒ± geri yaz
      - name: Restore pubspec
        run: |
          cat > pubspec.yaml << 'EOF'
          name: tabletkalem
          description: Tablet Kalem
          publish_to: 'none'
          version: 1.0.0+1

          environment:
            sdk: '>=3.0.0 <4.0.0'

          dependencies:
            flutter:
              sdk: flutter
            cupertino_icons: ^1.0.2
            system_alert_window: ^2.0.7

          dev_dependencies:
            flutter_test:
              sdk: flutter
            flutter_lints: ^2.0.0

          flutter:
            uses-material-design: true
          EOF

      # 2.5Ô∏è‚É£ MainActivity.kt'yi geri yaz
      - name: Restore MainActivity
        run: |
          mkdir -p android/app/src/main/kotlin/com/example/tabletkalem
          cat > android/app/src/main/kotlin/com/example/tabletkalem/MainActivity.kt << 'EOF'
          package com.example.tabletkalem

          import android.app.Activity
          import android.content.Intent
          import android.graphics.PixelFormat
          import android.media.ImageReader
          import android.media.projection.MediaProjectionManager
          import android.os.Handler
          import android.os.Looper
          import android.view.WindowManager
          import io.flutter.embedding.android.FlutterActivity
          import io.flutter.embedding.engine.FlutterEngine
          import io.flutter.plugin.common.MethodChannel

          class MainActivity : FlutterActivity() {

              private val CHANNEL = "screenshot_channel"
              private val REQUEST_CODE = 1001
              private var resultCallback: MethodChannel.Result? = null

              override fun configureFlutterEngine(flutterEngine: FlutterEngine) {
                  super.configureFlutterEngine(flutterEngine)

                  MethodChannel(
                      flutterEngine.dartExecutor.binaryMessenger,
                      CHANNEL
                  ).setMethodCallHandler { call, result ->
                      if (call.method == "takeScreenshot") {
                          resultCallback = result
                          val manager =
                              getSystemService(Activity.MEDIA_PROJECTION_SERVICE) as MediaProjectionManager
                          startActivityForResult(
                              manager.createScreenCaptureIntent(),
                              REQUEST_CODE
                          )
                      } else {
                          result.notImplemented()
                      }
                  }
              }

              override fun onActivityResult(requestCode: Int, resultCode: Int, data: Intent?) {
                  if (requestCode == REQUEST_CODE && resultCode == Activity.RESULT_OK && data != null) {

                      val wm = getSystemService(WINDOW_SERVICE) as WindowManager
                      val bounds = wm.currentWindowMetrics.bounds
                      val width = bounds.width()
                      val height = bounds.height()

                      val reader = ImageReader.newInstance(
                          width,
                          height,
                          PixelFormat.RGBA_8888,
                          1
                      )

                      val projectionManager =
                          getSystemService(Activity.MEDIA_PROJECTION_SERVICE) as MediaProjectionManager
                      val projection =
                          projectionManager.getMediaProjection(resultCode, data)

                      val virtualDisplay = projection.createVirtualDisplay(
                          "screen",
                          width,
                          height,
                          resources.displayMetrics.densityDpi,
                          0,
                          reader.surface,
                          null,
                          null
                      )

                      reader.setOnImageAvailableListener({ ir ->
                          val image = ir.acquireLatestImage() ?: return@setOnImageAvailableListener
                          val buffer = image.planes[0].buffer
                          val bytes = ByteArray(buffer.remaining())
                          buffer.get(bytes)
                          image.close()

                          virtualDisplay.release()
                          projection.stop()

                          resultCallback?.success(bytes)
                      }, Handler(Looper.getMainLooper()))
                  }
                  super.onActivityResult(requestCode, resultCode, data)
              }
          }
          EOF

      # 2.6Ô∏è‚É£ AndroidManifest.xml'yi geri yaz (V2 EMBEDDING - DOƒûRU YER)
      - name: Restore AndroidManifest
        run: |
          cat > android/app/src/main/AndroidManifest.xml << 'EOF'
          <manifest xmlns:android="http://schemas.android.com/apk/res/android"
              package="com.example.tabletkalem">

              <application
                  android:label="tabletkalem"
                  android:icon="@mipmap/ic_launcher">

                  <!-- üî¥ Flutter v2 embedding bildirimi (DOƒûRU YER) -->
                  <meta-data
                      android:name="flutterEmbedding"
                      android:value="2" />

                  <activity
                      android:name=".MainActivity"
                      android:exported="true"
                      android:launchMode="singleTop"
                      android:configChanges="orientation|keyboardHidden|keyboard|screenSize|locale|layoutDirection|fontScale|screenLayout|density|uiMode"
                      android:hardwareAccelerated="true"
                      android:windowSoftInputMode="adjustResize">

                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>

                  </activity>

              </application>
          </manifest>
          EOF

      # 3Ô∏è‚É£ Paketleri √ßek
      - name: Flutter Pub Get
        run: flutter pub get

      # 4Ô∏è‚É£ APK BUILD
      - name: Build APK
        run: flutter build apk --release --split-per-abi

      - uses: actions/upload-artifact@v4
        with:
          name: TabletKalem-APK
          path: build/app/outputs/flutter-apk/*.apk
